<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>QTCL v5.0 â€” Quantum Temporal Coherence Ledger</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#050508;
  --bg2:#0a0a12;
  --bg3:#0f0f1a;
  --panel:#0d0d18;
  --border:#1a1a2e;
  --border2:#252545;
  --border-light:#363654;
  --cyan:#00d4ff;
  --cyan2:#00a0cc;
  --cyan-dark:#0088aa;
  --green:#2ecc71;
  --green2:#1a7a45;
  --amber:#f0b429;
  --red:#e05252;
  --purple:#bb86fc;
  --dim:#404060;
  --mid:#606080;
  --text:#d0d0e8;
  --text-dim:#a0a0b8;
  --glow-cyan: 0 0 12px rgba(0,212,255,0.3);
  --glow-green: 0 0 10px rgba(46,204,113,0.25);
  --glow-purple: 0 0 10px rgba(187,134,252,0.25);
  --transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Fira Code','Menlo','Monaco','Courier New',monospace;font-size:13px;background:var(--bg);color:var(--text);line-height:1.6;letter-spacing:0.3px;position:fixed;}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
#app{display:flex;flex-direction:column;height:100vh}

/* â”€â”€â”€ TOP BAR â”€â”€â”€ */
#topbar{
  display:flex;align-items:center;gap:0;
  background:linear-gradient(90deg,#02020a 0%,#08081a 100%);
  border-bottom:2px solid var(--border);
  padding:0;
  flex-shrink:0;
  height:50px;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
#brand{
  display:flex;align-items:center;gap:12px;
  padding:0 22px;border-right:2px solid var(--border);
  height:100%;
}
.brand-icon{font-size:18px;color:var(--cyan)}
.brand-name{
  font-size:13px;font-weight:bold;letter-spacing:3px;
  color:var(--cyan);text-shadow:var(--glow-cyan);
}
.brand-version{
  font-size:10px;color:var(--mid);letter-spacing:1px;margin-left:8px;
}

/* â”€â”€â”€ TABS â”€â”€â”€ */
#tabs{display:flex;height:100%;flex:1}
.tab{
  display:flex;align-items:center;gap:8px;
  padding:0 24px;cursor:pointer;
  border-right:1px solid var(--border);
  font-size:11px;letter-spacing:2px;font-weight:bold;
  color:var(--dim);transition:var(--transition);
  text-transform:uppercase;position:relative;
  user-select:none;
}
.tab:hover{color:var(--text);background:rgba(255,255,255,0.01)}
.tab.active{
  color:var(--cyan);
  background:rgba(0,212,255,0.06);
}
.tab.active::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--cyan),var(--cyan2));box-shadow:var(--glow-cyan);
}
.tab-dot{width:7px;height:7px;border-radius:50%;background:var(--dim)}
.tab.active .tab-dot{background:var(--cyan);box-shadow:var(--glow-cyan);animation:pulse 2.5s ease-in-out infinite}

/* â”€â”€â”€ STATUS STRIP â”€â”€â”€ */
#statusbar{
  margin-left:auto;display:flex;align-items:center;gap:20px;
  padding-right:20px;font-size:10px;color:var(--dim);letter-spacing:1px;
  text-transform:uppercase;
}
.stat{display:flex;align-items:center;gap:7px;padding:0 10px}
.stat-dot{width:6px;height:6px;border-radius:50%;animation:pulse 2.5s ease-in-out infinite}
.stat-dot.ok{background:var(--green);box-shadow:var(--glow-green)}
.stat-dot.warn{background:var(--amber);animation:none;opacity:0.7}
.stat-dot.off{background:var(--red);animation:none;opacity:0.6}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(1.1)}}

/* â”€â”€â”€ CONTENT AREA â”€â”€â”€ */
#content{flex:1;overflow:hidden;display:flex}

/* â”€â”€â”€ TERMINAL TAB â”€â”€â”€ */
#terminal-view{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€â”€ TERMINAL OUTPUT â”€â”€â”€ */
#output{
  flex:1;overflow-y:auto;overflow-x:hidden;
  padding:16px 20px;background:var(--bg);
}
#output::-webkit-scrollbar{width:6px}
#output::-webkit-scrollbar-track{background:transparent}
#output::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px;transition:var(--transition)}
#output::-webkit-scrollbar-thumb:hover{background:var(--dim)}

/* â”€â”€â”€ OUTPUT LINES â”€â”€â”€ */
.line{margin-bottom:4px;white-space:pre-wrap;word-wrap:break-word;font-size:13px;animation:fadeIn 0.15s ease;font-variant-numeric:tabular-nums}
@keyframes fadeIn{from{opacity:0;transform:translateY(2px)}to{opacity:1;transform:translateY(0)}}
.line-prompt{color:var(--mid)}
.line-cmd{color:var(--text);font-weight:500}
.line-success{color:var(--green)}
.line-error{color:var(--red)}
.line-info{color:#5a9ccc}
.line-warning{color:var(--amber)}
.line-system{color:var(--cyan);opacity:0.85}
.line-dim{color:var(--dim)}
.line-header{color:var(--cyan);font-weight:bold;letter-spacing:2px;border-bottom:1px solid var(--border);padding-bottom:3px;margin-bottom:6px}

/* prompt line */
.prompt-line{display:flex;gap:7px;margin-bottom:4px;align-items:flex-start}
.prompt-arrow{color:var(--cyan);opacity:0.7;font-weight:bold;min-width:15px}
.prompt-cmd-text{color:var(--text)}

/* â”€â”€â”€ INPUT AREA â”€â”€â”€ */
#inputbar{
  display:flex;align-items:center;
  padding:12px 20px;gap:12px;
  border-top:2px solid var(--border);
  background:linear-gradient(90deg,var(--bg) 0%,var(--bg2) 100%);
  flex-shrink:0;
  position:relative;
  z-index:9999;
  box-shadow:0 -2px 10px rgba(0,0,0,0.5);
}
.input-ps1{color:var(--cyan);opacity:0.8;user-select:none;font-size:13px;flex-shrink:0;font-weight:bold}
#cmd{
  flex:1;background:transparent;border:none;outline:none;
  color:var(--text);font-family:inherit;font-size:13px;caret-color:var(--cyan);
  padding:8px 4px;
  -webkit-user-select:text;
  user-select:text;
}
#cmd::placeholder{color:var(--dim)}
#cmd:focus{color:var(--text);outline:none;border-bottom:1px solid var(--cyan)}
#exec-btn{
  padding:8px 16px;background:rgba(0,212,255,0.08);
  border:1px solid var(--border-light);color:var(--cyan);
  cursor:pointer;border-radius:3px;font-size:11px;letter-spacing:1px;
  font-family:inherit;transition:var(--transition);text-transform:uppercase;font-weight:bold;
  min-width:50px;
  flex-shrink:0;
}
#exec-btn:hover{background:rgba(0,212,255,0.18);border-color:var(--cyan);box-shadow:0 0 10px rgba(0,212,255,0.2)}
#exec-btn:active{transform:scale(0.98)}

/* â”€â”€â”€ INFO TAB â”€â”€â”€ */
#info-view{
  flex:1;display:none;overflow-y:auto;overflow-x:hidden;
  padding:24px;background:var(--bg2);
}
#info-view.active{display:block}
#info-view::-webkit-scrollbar{width:6px}
#info-view::-webkit-scrollbar-track{background:transparent}
#info-view::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
#info-view::-webkit-scrollbar-thumb:hover{background:var(--dim)}

.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;margin-bottom:24px}
.info-card{
  background:linear-gradient(135deg,var(--panel) 0%,var(--bg3) 100%);
  border:1px solid var(--border-light);
  border-radius:6px;padding:18px;
  transition:var(--transition);
  box-shadow:0 4px 6px rgba(0,0,0,0.2);
}
.info-card:hover{border-color:var(--cyan);box-shadow:0 0 15px rgba(0,212,255,0.15)}
.info-card-title{
  font-size:11px;letter-spacing:2px;text-transform:uppercase;
  color:var(--cyan);margin-bottom:14px;opacity:0.9;
  border-bottom:2px solid var(--border);padding-bottom:8px;
  font-weight:bold;
}
.info-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:12px}
.info-key{color:var(--mid);font-weight:500}
.info-val{color:var(--green);font-weight:bold;font-variant-numeric:tabular-nums}
.info-val.dim{color:var(--dim)}
.info-val.warn{color:var(--amber)}
.info-val.cyan{color:var(--cyan)}
.info-val.purple{color:var(--purple)}

.cmd-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.cmd-tag{
  padding:4px 10px;background:rgba(0,212,255,0.08);
  border:1px solid var(--border-light);border-radius:3px;
  font-size:10px;color:var(--cyan);letter-spacing:0.5px;cursor:pointer;
  transition:var(--transition);font-weight:500;
}
.cmd-tag:hover{background:rgba(0,212,255,0.2);border-color:var(--cyan);box-shadow:var(--glow-cyan);transform:scale(1.05)}
.cmd-tag:active{transform:scale(0.95)}

/* â”€â”€â”€ COMMAND CATEGORIES â”€â”€â”€ */
.category-section{margin-bottom:28px}
.category-header{
  font-size:12px;letter-spacing:2px;text-transform:uppercase;
  color:var(--purple);margin-bottom:12px;opacity:0.9;
  font-weight:bold;padding-bottom:6px;border-bottom:1px solid var(--border);
}

/* â”€â”€â”€ SPINNER â”€â”€â”€ */
.spinner{
  display:inline-block;width:12px;height:12px;border:2px solid var(--dim);
  border-top:2px solid var(--cyan);border-radius:50%;
  animation:spin 0.8s linear infinite;vertical-align:middle;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€ MOBILE OPTIMIZATIONS â”€â”€â”€ */
@media (max-width: 768px) {
  #app{
    height:100vh;
    max-height:100vh;
    overflow:hidden;
  }
  
  #content{
    overflow:hidden;
    max-height:calc(100vh - 95px);
  }
  
  #inputbar{
    padding:10px 12px;
    gap:8px;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    width:100%;
    height:auto;
    min-height:50px;
    border-top:2px solid var(--border);
    border-bottom:none;
    box-shadow:0 -4px 20px rgba(0,0,0,0.9);
    z-index:9999;
    background:var(--bg);
    display:flex !important;
    visibility:visible !important;
    opacity:1 !important;
  }
  
  #terminal-view{
    flex:1;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    height:calc(100vh - 95px);
  }
  
  #output{
    flex:1;
    overflow-y:auto;
    overflow-x:hidden;
    padding:12px 14px;
    padding-bottom:60px;
  }
  
  .input-ps1{
    font-size:11px;
    min-width:35px;
  }
  
  #cmd{
    font-size:16px;
    padding:12px 8px;
    min-height:38px;
    border:1px solid var(--border-light);
    border-radius:3px;
    background:rgba(255,255,255,0.02);
  }
  
  #cmd:focus{
    border:1px solid var(--cyan);
    background:rgba(0,212,255,0.05);
  }
  
  #exec-btn{
    padding:10px 12px;
    font-size:12px;
    min-width:55px;
    min-height:38px;
  }

  .brand-name{font-size:11px}
  .tab{padding:0 14px;font-size:9px}
  #topbar{height:45px}
  .info-grid{grid-template-columns:1fr}
  #statusbar{gap:10px;padding-right:14px}
}

/* â”€â”€â”€ PQC TECH DESCRIPTION PANEL â”€â”€â”€ */
.pqc-panel {
  background: linear-gradient(135deg, #07071a 0%, #0a0a1f 50%, #060614 100%);
  border: 1px solid #1a1a3a;
  border-left: 3px solid var(--purple);
  border-radius: 6px;
  padding: 22px 26px 26px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}
.pqc-panel::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--purple), var(--cyan), transparent);
  opacity: 0.4;
}
.pqc-panel-title {
  font-size: 11px;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--purple);
  font-weight: bold;
  margin-bottom: 6px;
  text-shadow: 0 0 12px rgba(187,134,252,0.4);
}
.pqc-panel-subtitle {
  font-size: 10px;
  color: var(--mid);
  letter-spacing: 1px;
  margin-bottom: 18px;
  padding-bottom: 14px;
  border-bottom: 1px solid #1a1a35;
}
.pqc-section { margin-bottom: 18px; }
.pqc-section-hdr {
  font-size: 10px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--cyan);
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid #151530;
}
.pqc-body {
  font-size: 11.5px;
  color: var(--text-dim);
  line-height: 1.8;
  letter-spacing: 0.2px;
}
.pqc-body em { color: var(--cyan); font-style: normal; font-weight: bold; }
.pqc-body strong { color: var(--text); font-weight: bold; }
.pqc-body .hl-purple { color: var(--purple); font-weight: bold; }
.pqc-body .hl-green  { color: var(--green);  font-weight: bold; }
.pqc-body .hl-amber  { color: var(--amber);  font-weight: bold; }
.pqc-math {
  font-family: 'Fira Code', monospace;
  font-size: 11px;
  color: #88aaff;
  background: rgba(0,0,40,0.6);
  border: 1px solid #1a1a40;
  border-radius: 4px;
  padding: 10px 14px;
  margin: 8px 0;
  line-height: 1.7;
  overflow-x: auto;
  white-space: pre;
}
.pqc-grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 10px;
}
@media (max-width: 700px) { .pqc-grid-2 { grid-template-columns: 1fr; } }
.pqc-stat {
  background: rgba(0,0,30,0.5);
  border: 1px solid #1a1a35;
  border-radius: 4px;
  padding: 10px 14px;
}
.pqc-stat-label { font-size: 10px; color: var(--dim); letter-spacing: 1px; margin-bottom: 3px; }
.pqc-stat-val   { font-size: 12px; color: var(--cyan); font-weight: bold; }
.pqc-cap-row { display:flex; align-items:center; gap:8px; margin-bottom:5px; font-size:11.5px; }
.pqc-cap-dot { width:6px; height:6px; border-radius:50%; background:var(--dim); flex-shrink:0; }
.pqc-cap-dot.on { background:var(--green); box-shadow:0 0 6px rgba(46,204,113,0.5); }
.pqc-cap-dot.off { background:var(--red); }
.pqc-cap-dot.partial { background:var(--amber); }
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar">
    <div id="brand">
      <span class="brand-icon">âš›</span>
      <span class="brand-name">QTCL</span>
      <span class="brand-version">v5.0</span>
    </div>
    <div id="tabs">
      <div class="tab active" data-view="terminal" onclick="switchTab('terminal')">
        <div class="tab-dot"></div>TERMINAL
      </div>
      <div class="tab" data-view="info" onclick="switchTab('info')">
        <div class="tab-dot"></div>INFO
      </div>
    </div>
    <div id="statusbar">
      <div class="stat">
        <div class="stat-dot ok" id="dot-api"></div>
        <span id="lbl-api">API</span>
      </div>
      <div class="stat">
        <div class="stat-dot warn" id="dot-quantum"></div>
        <span id="lbl-quantum">QUANTUM</span>
      </div>
      <div class="stat">
        <div class="stat-dot warn" id="dot-db"></div>
        <span id="lbl-db">DB</span>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- TERMINAL VIEW -->
    <div id="terminal-view">
      <div id="output"></div>
      <div id="inputbar">
        <span class="input-ps1">QTCL â€º</span>
        <input type="text" id="cmd" placeholder="Type 'help' for commandsâ€¦" spellcheck="false" autocomplete="off">
        <button id="exec-btn">RUN</button>
      </div>
    </div>

    <!-- INFO VIEW -->
    <div id="info-view">
      <div id="info-content">
        <!-- Dynamically populated -->
      </div>
    </div>

  </div>
</div>

<script>
'use strict';

// â”€â”€â”€ GLOBAL STATE â”€â”€â”€
const state = {
  output: document.getElementById('output'),
  cmdInput: document.getElementById('cmd'),
  cmdHistory: [],
  histIdx: -1,
  statusData: {},
  allCommands: [],
  commandsByCategory: {},
  isLoading: false,
  isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
};

// â”€â”€â”€ TAB SWITCHING â”€â”€â”€
function switchTab(name) {
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-view="${name}"]`).classList.add('active');
  
  const termView = document.getElementById('terminal-view');
  const infoView = document.getElementById('info-view');
  
  if (name === 'terminal') {
    termView.style.display = 'flex';
    infoView.classList.remove('active');
    setTimeout(() => state.cmdInput.focus(), 50);
  } else {
    termView.style.display = 'none';
    infoView.classList.add('active');
    // Fetch fresh PQC telemetry each time info tab is opened
    loadPQCStatus();
  }
}

// â”€â”€â”€ OUTPUT UTILITIES â”€â”€â”€
function addLine(text, style = 'system') {
  const line = document.createElement('div');
  line.className = `line line-${style}`;
  line.textContent = text;
  state.output.appendChild(line);
  state.output.scrollTop = state.output.scrollHeight;
}

function addPromptLine(cmd) {
  const container = document.createElement('div');
  container.className = 'prompt-line';
  container.innerHTML = `<span class="prompt-arrow">â€º</span><span class="prompt-cmd-text">${escapeHtml(cmd)}</span>`;
  state.output.appendChild(container);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// â”€â”€â”€ COMMAND EXECUTION â”€â”€â”€
async function execute() {
  const raw = state.cmdInput.value.trim();
  if (!raw || state.isLoading) return;

  state.cmdHistory.unshift(raw);
  state.histIdx = -1;
  state.cmdInput.value = '';

  addPromptLine(raw);

  // Local client-side commands
  const lc = raw.toLowerCase();
  if (lc === 'clear' || lc === 'cls') { state.output.innerHTML = ''; return; }
  if (lc === 'info') { switchTab('info'); return; }
  if (lc === 'help') { showDynamicHelp(); return; }

  state.isLoading = true;
  state.cmdInput.disabled = true;

  try {
    // Parse via executor so --flag=value and slash-notation are handled correctly
    const parsed   = window.qtclExecutor
      ? window.qtclExecutor.parse(raw)
      : { command: raw.replace(/\//g, '-'), args: [], kwargs: {} };
    const cmdStr   = window.qtclExecutor
      ? window.qtclExecutor.buildCommandString(parsed.command, parsed.args, parsed.kwargs)
      : parsed.command;

    const token = window.qtclExecutor ? window.qtclExecutor.getToken() : '';
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = `Bearer ${token}`;

    // â”€â”€ CRITICAL FIX (2026): AbortController timeout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Previously: raw fetch() with NO timeout â†’ Gunicorn killed the worker after
    // 30 s â†’ broken HTTP body â†’ res.json() threw â†’ 'Invalid JSON response'.
    // Fix: abort the fetch after 35 s and return a clean JSON error object.
    // The server-side timeout is 25 s, so 35 s on the client ensures the server
    // always responds first (with a proper JSON timeout message) in normal cases.
    // The extra 10 s is a safety margin for slow quantum module initialization.
    const _abort = new AbortController();
    const _abortTimer = setTimeout(() => _abort.abort(), 35000);

    let res, data;
    try {
      res = await fetch('/api/command', {
        method:  'POST',
        headers,
        body:    JSON.stringify({ command: cmdStr, args: [], kwargs: {} }),
        signal:  _abort.signal
      });
      clearTimeout(_abortTimer);

      // â”€â”€ Robust JSON parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // res.json() CAN fail even with a 200 OK if:
      //   â€¢ The server returned an HTML error page (Content-Type mismatch)
      //   â€¢ The response body is empty or truncated (worker restart)
      //   â€¢ The body starts with a BOM or whitespace
      // Strategy:
      //   1. Try res.json() natively
      //   2. Fall back to parsing res.text() manually
      //   3. Last resort: return structured error so the UI shows useful info
      let rawText = '';
      try {
        data = await res.json();
      } catch (_jsonErr) {
        try {
          rawText = await res.text().catch(() => '');
          rawText = rawText.trim();
          // Strip BOM and leading whitespace/logging lines before the JSON
          const jsonStart = rawText.search(/[{[]/);
          if (jsonStart > 0) {
            console.warn('[Terminal] Response had leading non-JSON content, stripping:',
                         rawText.slice(0, Math.min(jsonStart, 200)));
            rawText = rawText.slice(jsonStart);
          }
          data = JSON.parse(rawText);
        } catch (_parseErr) {
          console.error('[Terminal] JSON parse failed:', _parseErr, '| raw:', rawText.slice(0, 500));
          // Detect common server error patterns in the raw body
          const isHtml   = rawText.includes('<!DOCTYPE') || rawText.includes('<html');
          const isGunicornTimeout = rawText.includes('Worker timeout') || rawText === '';
          data = {
            status: 'error',
            error: isGunicornTimeout
              ? 'Server worker timed out â€” quantum initialization may still be in progress. Please retry in a few seconds.'
              : isHtml
              ? 'Server returned an HTML error page instead of JSON. Check server logs.'
              : `Response could not be parsed as JSON. Raw snippet: ${rawText.slice(0, 120)}`,
            _parse_error: _parseErr.message,
            _http_status: res.status,
          };
        }
      }
    } catch (_fetchErr) {
      clearTimeout(_abortTimer);
      const isAbort = _fetchErr.name === 'AbortError';
      data = {
        status: 'error',
        error: isAbort
          ? 'Command timed out after 35 s. The server may be initializing quantum components â€” please retry in a few seconds.'
          : `Network error: ${_fetchErr.message}`,
        _aborted: isAbort,
      };
      res = { ok: false, status: 0 };
    }

    // â”€â”€ Token capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // AuthHandlers returns access_token at TOP LEVEL (not nested in result)
    const tok = data.token || data.access_token
              || data.result?.token || data.result?.access_token;
    if (tok && window.qtclExecutor) window.qtclExecutor.setToken(tok);

    if (res.ok && (data.status === 'success' || data.result !== undefined || data.access_token !== undefined)) {
      // Auth responses: payload IS the top-level dict (access_token, user_id, role, etc.)
      const result = data.result ?? (data.access_token ? data : null);
      if (!result) {
        addLine('âœ“ OK', 'success');
      } else if (typeof result === 'object') {
        if (result.output) {
          result.output.split('\n').forEach(l => {
            if (l.trim()) addLine(l, l.includes('â”€') || l.includes('â•') || l.includes('â•‘') ? 'system' : 'success');
          });
        } else {
          try {
            const pretty = JSON.stringify(result, null, 2);
            pretty.split('\n').forEach(l => addLine(l, 'success'));
          } catch {
            addLine(String(result), 'success');
          }
        }
      } else {
        String(result).split('\n').forEach(l => { if (l.trim()) addLine(l, 'success'); });
      }
    } else {
      const errMsg = data.error || `HTTP ${res.status || 'unknown'}`;
      addLine('âœ— ' + errMsg, 'error');
      if (data.hint) addLine('  â†³ ' + data.hint, 'warning');
      if (data.suggestions && data.suggestions.length) {
        addLine('Similar: ' + data.suggestions.join(', '), 'warning');
      }
    }
  } catch (err) {
    addLine('Error: ' + err.message, 'error');
  } finally {
    state.isLoading = false;
    state.cmdInput.disabled = false;
    state.output.scrollTop = state.output.scrollHeight;
    if (state.isMobile) {
      setTimeout(() => {
        state.cmdInput.focus();
        state.cmdInput.scrollIntoView({ behavior: 'instant', block: 'end' });
      }, 50);
    } else {
      state.cmdInput.focus();
    }
  }
}

// â”€â”€â”€ DYNAMIC COMMAND LOADING â”€â”€â”€
async function loadCommands() {
  try {
    addLine('Loading command registry from globalsâ€¦', 'dim');
    const res = await fetch('/api/commands');
    if (res.ok) {
      const data = await res.json();
      // API returns commands as a plain object keyed by name â€” normalize to array
      const raw = data.commands || data || {};
      if (Array.isArray(raw)) {
        state.allCommands = raw;
      } else {
        state.allCommands = Object.entries(raw).map(([name, info]) => ({
          name,
          category: info.category || 'misc',
          description: info.description || '',
          auth_required: info.auth_required || false,
          ...info
        }));
      }
      state.commandsByCategory = {};

      state.allCommands.forEach(cmd => {
        const cat = cmd.category || 'misc';
        if (!state.commandsByCategory[cat]) {
          state.commandsByCategory[cat] = [];
        }
        state.commandsByCategory[cat].push(cmd);
      });
      
      addLine(`âœ“ Loaded ${state.allCommands.length} commands from registry`, 'success');
      renderInfoGrid();
    } else {
      addLine('âš  Could not load commands', 'warning');
    }
  } catch (e) {
    addLine(`âš  Command load error: ${e.message}`, 'warning');
    console.error('Command load failed:', e);
  }
}

// â”€â”€â”€ DYNAMIC HELP â”€â”€â”€
function showDynamicHelp() {
  addLine('', 'dim');
  addLine('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'system');
  addLine('â•‘  QTCL v5.0 â€” COMMAND REFERENCE & SYNTAX GUIDE          â•‘', 'system');
  addLine('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'system');
  addLine('', 'dim');

  addLine('ğŸ“± MOBILE UX TIPS:', 'info');
  addLine('  â€¢ Input box auto-focuses at bottom of screen', 'dim');
  addLine('  â€¢ Click/tap terminal â†’ input focuses', 'dim');
  addLine('  â€¢ Keyboard opens automatically', 'dim');
  addLine('  â€¢ Press RUN button or Enter to execute', 'dim');
  addLine('', 'dim');

  addLine('ğŸ¯ COMMAND SYNTAX â€” HYPHEN-SEPARATED (canonical format):', 'warning');
  addLine('  Format: category-command --flag=value --bool-flag', 'text');
  addLine('', 'dim');
  addLine('  EXAMPLES:', 'success');
  addLine('    âœ“ admin-users                   list all users', 'dim');
  addLine('    âœ“ admin-users --limit=20 --role=admin', 'dim');
  addLine('    âœ“ quantum-status                quantum engine metrics', 'dim');
  addLine('    âœ“ block-details --block=42      block by number', 'dim');
  addLine('    âœ“ oracle-price --symbol=BTCUSD  live price feed', 'dim');
  addLine('    âœ“ system-stats                 full system stats & health', 'dim');
  addLine('    âœ“ login --email=x --password=y  authenticate', 'dim');
  addLine('    âœ“ help-commands                 list all commands', 'dim');
  addLine('    âœ“ help-category --category=defi show defi commands', 'dim');
  addLine('', 'dim');
  addLine('  NOTE: quantum/status also works â€” slash auto-converts to hyphen', 'dim');
  addLine('', 'dim');

  addLine('ğŸ“– HELP COMMANDS:', 'info');
  addLine('  help                    This menu', 'dim');
  addLine('  help-commands           List ALL registered commands', 'dim');
  addLine('  help-category --category=admin    Show admin commands', 'dim');
  addLine('  help-category --category=quantum  Show quantum commands', 'dim');
  addLine('  help-category --category=defi     Show DeFi commands', 'dim');
  addLine('', 'dim');

  if (Object.keys(state.commandsByCategory).length === 0) {
    addLine('(Commands not yet loaded â€” visit INFO tab to load)', 'dim');
  } else {
    addLine('ğŸ“‚ COMMAND CATEGORIES:', 'info');
    const categories = Object.keys(state.commandsByCategory).sort();
    categories.forEach(cat => {
      const count = state.commandsByCategory[cat].length;
      addLine(`  ${cat.padEnd(16)} (${count} commands)   help-category --category=${cat}`, 'dim');
    });
  }

  addLine('', 'dim');
  addLine('ğŸ’¡ QUICK START:', 'info');
  addLine('  1. help-commands           â€” see everything available', 'dim');
  addLine('  2. system-stats            â€” check all system components & health', 'dim');
  addLine('  3. quantum-status          â€” quantum engine metrics', 'dim');
  addLine('  4. oracle-price --symbol=BTCUSD  â€” live price', 'dim');
  addLine('  5. Click INFO tab          â€” visual system status', 'dim');
  addLine('', 'dim');
}

// â”€â”€â”€ KEYBOARD HANDLING â”€â”€â”€
state.cmdInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') { 
    e.preventDefault(); 
    execute(); 
  }
  else if (e.key === 'ArrowUp') {
    e.preventDefault();
    state.histIdx = Math.min(state.histIdx + 1, state.cmdHistory.length - 1);
    if (state.histIdx >= 0) state.cmdInput.value = state.cmdHistory[state.histIdx];
  }
  else if (e.key === 'ArrowDown') {
    e.preventDefault();
    state.histIdx = Math.max(state.histIdx - 1, -1);
    state.cmdInput.value = state.histIdx >= 0 ? state.cmdHistory[state.histIdx] : '';
  }
});

// â”€â”€â”€ BUTTON EVENT â”€â”€â”€
document.getElementById('exec-btn').addEventListener('click', execute);

// â”€â”€â”€ STATUS POLLING â”€â”€â”€
async function loadStatus() {
  try {
    const r = await fetch('/api/status');
    if (r.ok) {
      const d = await r.json();
      state.statusData = d;
      
      const qok = d.quantum && (d.quantum.status === 'active' || d.quantum.status === 'Active');
      setDot('quantum', qok ? 'ok' : 'warn');
      document.getElementById('lbl-quantum').textContent = 
        d.quantum ? (d.quantum.status || 'QUANTUM').toUpperCase().slice(0, 10) : 'QUANTUM';
      
      const dbok = d.database || d.db;
      setDot('db', dbok ? 'ok' : 'warn');
      
      setDot('api', 'ok');
      
      if (d.ledger && typeof d.ledger.blocks === 'number') {
        document.getElementById('lbl-db').textContent = d.ledger.blocks + ' BLK';
      }
    }
  } catch (e) { 
    setDot('api', 'warn');
  }
}

function setDot(id, cls) {
  const d = document.getElementById('dot-' + id);
  if (d) d.className = 'stat-dot ' + cls;
}

setInterval(loadStatus, 12000);

// â”€â”€â”€ PQC LIVE TELEMETRY â”€â”€â”€
// Cached from the last /api/pqc/status fetch
state.pqcData = {};

async function loadPQCStatus() {
  try {
    const r = await fetch('/api/pqc/status', { cache: 'no-store' });
    if (r.ok) {
      const j = await r.json();
      state.pqcData = j.data || j;
      renderInfoGrid(); // re-render with live data
    }
  } catch(e) {}
}

// â”€â”€â”€ INFO GRID â”€â”€â”€
function renderInfoGrid() {
  const container = document.getElementById('info-content');
  container.innerHTML = '';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PQC DESCRIPTION PANEL â€” dense world-class technical description
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const pqc = state.pqcData;
  const pqcInit   = pqc.initialized ?? false;
  const pqcParams = pqc.params || 'HLWE-256';
  const pqcKeys   = pqc.keys   || {};
  const pqcOps    = pqc.operations || {};
  const pqcEnt    = pqc.entropy   || {};
  const pqcTess   = pqc.tessellation || {};
  const capDot = (on) => `<span class="pqc-cap-dot ${on ? 'on' : 'off'}"></span>`;

  const pqcPanel = document.createElement('div');
  pqcPanel.className = 'pqc-panel';
  pqcPanel.innerHTML = `
    <div class="pqc-panel-title">â¬¡ Post-Quantum Cryptography Engine</div>
    <div class="pqc-panel-subtitle">
      HLWE â€” Hyperbolic Learning With Errors &nbsp;|&nbsp;
      PSL(2,â„) / {8,3} Tessellation &nbsp;|&nbsp;
      ${pqcParams} &nbsp;|&nbsp; ${pqcInit ? '<span style="color:var(--green)">ACTIVE</span>' : '<span style="color:var(--amber)">INITIALIZING</span>'}
    </div>

    <!-- â”€â”€ HARD PROBLEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="pqc-section">
      <div class="pqc-section-hdr">Hard Problem &amp; Quantum Resistance</div>
      <div class="pqc-body">
        The cryptographic bedrock of every key, signature, and encapsulation in this system is
        the <em>Hyperbolic Learning With Errors</em> (HLWE) problem â€” a geometric generalization
        of Ring-LWE into the non-Euclidean hyperbolic plane <strong>â„Â²</strong>.
        The hard instance is stated as: given <em>k</em> public landmark points
        <strong>zâ‚ â€¦ z_k</strong> drawn from a depth-5 <em>{8,3} triangular tessellation</em>
        of the PoincarÃ© disk, and noisy hyperbolic distances
        <strong>báµ¢ = d_â„(záµ¢, s) + eáµ¢</strong> (where eáµ¢ ~ N(0,ÏƒÂ²)), recover the secret
        center <strong>s âˆˆ â„Â²</strong>. This is computationally intractable under four
        independent hardness properties absent from any Euclidean lattice scheme:
      </div>
      <div class="pqc-math">â‘  PSL(2,â„) isometry group is NON-ABELIAN
       â†’ Shor / Kitaev Hidden Subgroup Problem requires abelian structure â€” inapplicable here.

â‘¡ Hyperbolic volume growth is EXPONENTIAL:  vol(Báµ£) ~ eÊ³  (vs  râ¿ Euclidean)
   â†’ Each unit of radial depth multiplies search space exponentially.
   â†’ Effective attack dimension is doubly-exponential in Euclidean equivalents.

â‘¢ {8,3} triangle group Î”(2,3,8) has NO known efficient quantum algorithm.
   â†’ Automorphism group is a non-elementary hyperbolic group (word problem is in P,
     conjugacy / isomorphism are undecidable in the general case).

â‘£ Lattice basis reduction (LLL, BKZ-2020, sieving) is UNDEFINED on â„Â²
   â†’ All polynomial-time classical lattice attacks degenerate to brute-force search.</div>
      <div class="pqc-body" style="margin-top:10px">
        The <span class="hl-purple">pseudoqubit identity binding</span> mechanism adds a fifth,
        operational layer of security: every private key <em>s</em> is derived as the
        geodesic midpoint between the user's canonical tessellation anchor
        <strong>anchor(pq_id) âˆˆ {8,3}</strong> and a private entropy point sampled from
        three independent QRNG sources. Revoking the DB row for <code>pseudoqubit_id</code>
        makes the anchor mathematically unreachable â€” the derivation path is
        <span class="hl-amber">cryptographically dead</span> without any key distribution or CRL.
      </div>
    </div>

    <!-- â”€â”€ MATHEMATICAL FOUNDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="pqc-section">
      <div class="pqc-section-hdr">Mathematical Foundation â€” PoincarÃ© Disk &amp; {8,3} Tessellation</div>
      <div class="pqc-body">
        All computations operate in the <em>PoincarÃ© disk model</em> of the hyperbolic plane:
        <strong>â„Â² = {z âˆˆ â„‚ : |z| &lt; 1}</strong> equipped with the Riemannian metric
        <strong>dsÂ² = 4(dxÂ²+dyÂ²)/(1âˆ’|z|Â²)Â²</strong>. The isometry group is
        <em>PSL(2,â„)</em> â€” MÃ¶bius transformations of the form
        <strong>T(z) = (az+b)/(bÌ„z+Ä)</strong>, |a|Â²âˆ’|b|Â² = 1. Non-commutativity of
        composition (Tâ‚âˆ˜Tâ‚‚ â‰  Tâ‚‚âˆ˜Tâ‚) is the group-theoretic root of quantum resistance.
        Geodesic distances are computed via the exact formula
        <strong>d(zâ‚,zâ‚‚) = 2 arctanh(|zâ‚âˆ’zâ‚‚|/|1âˆ’zÌ„â‚zâ‚‚|)</strong> at
        <em>150 decimal places</em> of mpmath precision, matching the db_builder_v2 standard.
      </div>
      <div class="pqc-math">Tessellation {8,3}: octagonal {p=8} tiles, three meeting at each vertex {q=3}
Fundamental octagon vertex angle: Ï€/8  |  Meeting angle: Ï€/3
Triangle area (Gauss-Bonnet):  A = Ï€(1 âˆ’ 13/24) = 11Ï€/24
Circumradius:  cosh(R) = cos(Ï€/8)Â·cos(Ï€/3) / sinÂ²(Ï€/8)

Subdivision at depth d:  8 Ã— 4áµˆ triangles
Depth 5 total:  8 Ã— 4âµ = 8,192 triangles
Pseudoqubits per triangle:  13  (3 vertices + incenter + circumcenter + orthocenter + 7 barycentric)
Total positions:  8,192 Ã— 13 = 106,496 unique lattice anchors</div>
      <div class="pqc-body">
        Each of the <em>106,496 pseudoqubit positions</em> maps one-to-one to a unique
        PoincarÃ© disk coordinate via the canonical 5-level recursive MÃ¶bius subdivision.
        This gives every user a <span class="hl-purple">geometrically unique cryptographic identity</span>
        guaranteed by the infinite non-repeating structure of the {8,3} tiling â€” in direct analogy
        to how prime factorization gives RSA its uniqueness, but operating in a space where quantum
        algorithms have zero known purchase.
      </div>
    </div>

    <!-- â”€â”€ KEY ARCHITECTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="pqc-section">
      <div class="pqc-section-hdr">Six-Level Key Architecture</div>
      <div class="pqc-body">
        The system implements a complete 6-level hierarchical key architecture, each level
        building atomically on the one below it:
      </div>
      <div class="pqc-math">L0 â€” HyperbolicMath         : PoincarÃ© disk primitives (MÃ¶bius, geodesic, midpoint, barycentric)
L1 â€” HLWESampler            : Keypair generation â€” derives s = geodesic_midpoint(anchor(pq_id), entropy_point)
                              Public key: (landmark_seed, {báµ¢ = d_â„(záµ¢,s) + eáµ¢}áµ¢â‚Œâ‚áµ)
L2a â€” HyperKEM (IND-CCA2)  : Fujisaki-Okamoto KEM â€” ephemeral â„Â² encapsulation â†’ AES-256-GCM
L2b â€” HyperSign (EUF-CMA)  : Fiat-Shamir w/ Aborts over {8,3} walk â€” rejection-sampled signatures
L3 â€” HyperbolicKeyGenerator : BIP32-analogous HD tree: m / purpose / index via geodesic derivation
L4 â€” HyperZKProver          : Sigma-protocol (3-move) non-interactive ZK proofs of pseudoqubit ownership
     HyperbolicSecretSharing : Shamir (t,n) adapted to â„Â² â€” shares geometrically bound to pseudoqubits
L5 â€” KeyVaultManager        : AES-256-GCM encrypted key store (PostgreSQL) + cascade revocation CTE</div>
      <div class="pqc-body">
        Hybrid mode activates when <code>liboqs</code> is available: every HLWE operation is
        XOR-composed with its CRYSTALS counterpart â€” <span class="hl-green">Kyber-1024</span> for
        encapsulation, <span class="hl-green">Dilithium5</span> for signatures. This provides
        <em>defense-in-depth</em>: an attacker must simultaneously break both HLWE on PSL(2,â„)
        <strong>and</strong> NIST-standardized Module-LWE to recover any key material.
      </div>
    </div>

    <!-- â”€â”€ ENTROPY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="pqc-section">
      <div class="pqc-section-hdr">Quantum Entropy Pipeline</div>
      <div class="pqc-body">
        All key material originates from a <em>triple-source QRNG entropy hedge</em>.
        Sources are queried in parallel and XOR-combined: <strong>ANU Quantum Lab</strong>
        (vacuum fluctuation photon detection), <strong>Random.org</strong> (atmospheric noise),
        and <strong>LFDR German QRNG</strong> (quantum optical source). The XOR hedge guarantees
        that final entropy strength equals the <em>maximum</em> of individual source strengths â€”
        even if two sources are entirely compromised, the third source's entropy is fully preserved.
        A final SHA3-512 expansion pass ensures uniform distribution before any key derivation step.
        Each key is additionally domain-separated by its <code>pseudoqubit_id</code>, making QRNG
        collision attacks between users computationally infeasible even with identical raw entropy.
      </div>
    </div>

    <!-- â”€â”€ LIVE TELEMETRY GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="pqc-section">
      <div class="pqc-section-hdr">Live Telemetry</div>
      <div class="pqc-grid-2">
        <div class="pqc-stat"><div class="pqc-stat-label">PARAMETER SET</div>
          <div class="pqc-stat-val">${pqcParams}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">TESSELLATION</div>
          <div class="pqc-stat-val">${pqcTess.scheme || '{8,3} hyperbolic'}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">TOTAL ANCHORS</div>
          <div class="pqc-stat-val">${(pqcTess.total_positions || 106496).toLocaleString()}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">ASSIGNED</div>
          <div class="pqc-stat-val">${(pqcTess.assigned || 0).toLocaleString()}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">KEYS ACTIVE</div>
          <div class="pqc-stat-val" style="color:var(--green)">${pqcKeys.active ?? 'â€”'}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">KEYS REVOKED</div>
          <div class="pqc-stat-val" style="color:var(--red)">${pqcKeys.revoked ?? 'â€”'}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">SIGNATURES</div>
          <div class="pqc-stat-val">${pqcOps.signatures_produced ?? 'â€”'}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">ZK PROOFS</div>
          <div class="pqc-stat-val">${pqcOps.zk_proofs ?? 'â€”'}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">ENTROPY BYTES</div>
          <div class="pqc-stat-val">${(pqcEnt.total_bytes || 0).toLocaleString()}</div></div>
        <div class="pqc-stat"><div class="pqc-stat-label">QRNG HITS</div>
          <div class="pqc-stat-val">${((pqcEnt.sources?.anu_qrng||0)+(pqcEnt.sources?.random_org||0)+(pqcEnt.sources?.lfdr_qrng||0)).toLocaleString()}</div></div>
      </div>
    </div>

    <!-- â”€â”€ CAPABILITY FLAGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="pqc-section">
      <div class="pqc-section-hdr">System Capabilities</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 24px">
        <div class="pqc-cap-row">${capDot(pqcInit)}<span style="color:var(--text)">HLWE Engine</span><span style="color:var(--dim);font-size:10px;margin-left:auto">PSL(2,â„)</span></div>
        <div class="pqc-cap-row">${capDot(pqc.kyber_hybrid)}<span style="color:var(--text)">Kyber-1024 Hybrid</span><span style="color:var(--dim);font-size:10px;margin-left:auto">NIST L5</span></div>
        <div class="pqc-cap-row">${capDot(pqc.dilithium_hybrid)}<span style="color:var(--text)">Dilithium5 Hybrid</span><span style="color:var(--dim);font-size:10px;margin-left:auto">NIST L5</span></div>
        <div class="pqc-cap-row">${capDot(pqc.mpmath)}<span style="color:var(--text)">150-decimal Precision</span><span style="color:var(--dim);font-size:10px;margin-left:auto">mpmath</span></div>
        <div class="pqc-cap-row">${capDot(pqc.vault_schema_ready)}<span style="color:var(--text)">Encrypted Key Vault</span><span style="color:var(--dim);font-size:10px;margin-left:auto">AES-256-GCM</span></div>
        <div class="pqc-cap-row">${capDot(true)}<span style="color:var(--text)">Triple-Source QRNG</span><span style="color:var(--dim);font-size:10px;margin-left:auto">ANU+R.ORG+LFDR</span></div>
        <div class="pqc-cap-row">${capDot(true)}<span style="color:var(--text)">ZK Ownership Proofs</span><span style="color:var(--dim);font-size:10px;margin-left:auto">Sigma / FS</span></div>
        <div class="pqc-cap-row">${capDot(true)}<span style="color:var(--text)">Threshold Secret Sharing</span><span style="color:var(--dim);font-size:10px;margin-left:auto">(t,n) Shamir/â„Â²</span></div>
        <div class="pqc-cap-row">${capDot(true)}<span style="color:var(--text)">HD Key Derivation</span><span style="color:var(--dim);font-size:10px;margin-left:auto">BIP32-analogue</span></div>
        <div class="pqc-cap-row">${capDot(true)}<span style="color:var(--text)">Instant Cascade Revocation</span><span style="color:var(--dim);font-size:10px;margin-left:auto">CTE DB</span></div>
      </div>
    </div>

    <!-- â”€â”€ API ENDPOINTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="pqc-section" style="margin-bottom:0">
      <div class="pqc-section-hdr">REST Endpoints</div>
      <div class="pqc-body" style="font-size:11px;line-height:2">
        <code style="color:var(--cyan)">GET  /api/pqc/status</code> &nbsp;â€” live telemetry &amp; capability snapshot<br>
        <code style="color:var(--cyan)">POST /api/pqc/keygen</code> &nbsp;â€” generate HLWE master + subkey bundle<br>
        <code style="color:var(--cyan)">POST /api/pqc/sign</code> &nbsp;&nbsp;&nbsp;â€” HyperSign EUF-CMA signature<br>
        <code style="color:var(--cyan)">POST /api/pqc/verify</code> &nbsp;&nbsp;â€” verify HyperSign signature<br>
        <code style="color:var(--cyan)">POST /api/pqc/encapsulate</code> â€” IND-CCA2 KEM (HLWE+Kyber hybrid)<br>
        <code style="color:var(--cyan)">POST /api/pqc/prove-identity</code> â€” Sigma-protocol ZK proof<br>
        <code style="color:var(--cyan)">POST /api/pqc/revoke</code> &nbsp;&nbsp;â€” instant cascade key revocation<br>
        <code style="color:var(--cyan)">POST /api/pqc/rotate</code> &nbsp;&nbsp;â€” fresh-entropy key rotation
      </div>
    </div>
  `;
  container.appendChild(pqcPanel);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SYSTEM STATUS CARDS (original 4-card grid)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const archCard = document.createElement('div');
  archCard.className = 'info-card';
  archCard.innerHTML = `
    <div class="info-card-title">System Architecture</div>
    <div class="info-row"><span class="info-key">Blockchain Type</span><span class="info-val">Quantum-Classical</span></div>
    <div class="info-row"><span class="info-key">Consensus</span><span class="info-val">Quantum PoW + Classical PoS</span></div>
    <div class="info-row"><span class="info-key">Validator Qubits</span><span class="info-val cyan">5 (W-State)</span></div>
    <div class="info-row"><span class="info-key">Finality Proofs</span><span class="info-val purple">8-GHZ Circuit</span></div>
    <div class="info-row"><span class="info-key">PQC Scheme</span><span class="info-val purple">HLWE / PSL(2,â„)</span></div>
  `;
  
  const qCard = document.createElement('div');
  qCard.className = 'info-card';
  qCard.innerHTML = `
    <div class="info-card-title">Quantum Subsystem</div>
    <div class="info-row"><span class="info-key">Engine</span><span class="info-val">${state.statusData.quantum?.status || 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">W-State</span><span class="info-val cyan">${state.statusData.quantum?.w_state || 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Coherence</span><span class="info-val purple">${state.statusData.quantum?.coherence || 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Entropy Pool</span><span class="info-val">${state.statusData.quantum?.entropy || 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">QRNG Sources</span><span class="info-val green">3 Active</span></div>
  `;
  
  const ledgerCard = document.createElement('div');
  ledgerCard.className = 'info-card';
  ledgerCard.innerHTML = `
    <div class="info-card-title">Ledger Status</div>
    <div class="info-row"><span class="info-key">Blocks</span><span class="info-val">${state.statusData.ledger?.blocks ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Transactions</span><span class="info-val">${state.statusData.ledger?.transactions ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Validators</span><span class="info-val">${state.statusData.ledger?.validators ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Uptime</span><span class="info-val">${state.statusData.uptime ? Math.round(state.statusData.uptime) + 's' : 'â€”'}</span></div>
  `;
  
  const pqcLiveCard = document.createElement('div');
  pqcLiveCard.className = 'info-card';
  pqcLiveCard.innerHTML = `
    <div class="info-card-title" style="color:var(--purple)">PQC Key Vault</div>
    <div class="info-row"><span class="info-key">Active Keys</span><span class="info-val green">${pqcKeys.active ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Rotations</span><span class="info-val cyan">${pqcKeys.rotated ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Revocations</span><span class="info-val warn">${pqcKeys.revoked ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Encapsulations</span><span class="info-val">${pqcOps.encapsulations ?? 'â€”'}</span></div>
  `;
  
  const grid = document.createElement('div');
  grid.className = 'info-grid';
  grid.appendChild(archCard);
  grid.appendChild(qCard);
  grid.appendChild(ledgerCard);
  grid.appendChild(pqcLiveCard);
  container.appendChild(grid);

  const cats = Object.keys(state.commandsByCategory).sort();
  
  if (cats.length === 0) {
    const noCmd = document.createElement('div');
    noCmd.style.color = 'var(--dim)';
    noCmd.style.padding = '20px';
    noCmd.textContent = 'Commands not yet loaded. Run "help" in terminal.';
    container.appendChild(noCmd);
    return;
  }
  
  cats.forEach(category => {
    const section = document.createElement('div');
    section.className = 'category-section';
    
    const header = document.createElement('div');
    header.className = 'category-header';
    header.textContent = category.toUpperCase();
    section.appendChild(header);
    
    const cmdList = document.createElement('div');
    cmdList.className = 'cmd-list';
    
    state.commandsByCategory[category].forEach(cmd => {
      const tag = document.createElement('span');
      tag.className = 'cmd-tag';
      tag.textContent = cmd.name || cmd.command || '(unknown)';
      tag.onclick = () => runQuick(cmd.name || cmd.command);
      cmdList.appendChild(tag);
    });
    
    section.appendChild(cmdList);
    container.appendChild(section);
  });
}

function runQuick(cmd) {
  switchTab('terminal');
  state.cmdInput.value = cmd;
  execute();
}

// â”€â”€â”€ BOOT SEQUENCE â”€â”€â”€
async function boot() {
  const BOOT = [
    { t: 0, msg: 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', cls: 'system' },
    { t: 30, msg: 'â•‘     QUANTUM TEMPORAL COHERENCE LEDGER  v5.0               â•‘', cls: 'system' },
    { t: 30, msg: 'â•‘     Hybrid Blockchain Command Interface                    â•‘', cls: 'system' },
    { t: 30, msg: 'â•‘     Comments & Collaboration: shemshallah@gmail.com        â•‘', cls: 'system' },
    { t: 30, msg: 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', cls: 'system' },
    { t: 80, msg: '', cls: 'info' },
    { t: 60, msg: 'Initializing quantum subsystemâ€¦', cls: 'info' },
    { t: 80, msg: 'Loading command registry from globalsâ€¦', cls: 'info' },
    { t: 60, msg: 'Connecting to PostgreSQL ledgerâ€¦', cls: 'info' },
    { t: 100, msg: '', cls: 'info' },
    { t: 60, msg: 'Type  help            â€” list all commands from globals', cls: 'dim' },
    { t: 40, msg: 'Type  system-stats   â€” full system stats & health check', cls: 'dim' },
    { t: 40, msg: 'Type  quantum-status  â€” quantum engine metrics', cls: 'dim' },
    { t: 40, msg: 'Type  help-commands   â€” all 82+ registered commands', cls: 'dim' },
    { t: 40, msg: 'Click INFO tab        â€” system details & quick launch', cls: 'dim' },
    { t: 80, msg: '', cls: 'info' },
    { t: 60, msg: 'Ready.', cls: 'success' },
    { t: 20, msg: '', cls: 'info' },
  ];

  let delay = 0;
  for (const { t, msg, cls } of BOOT) {
    delay += t;
    await new Promise(r => setTimeout(r, delay));
    addLine(msg, cls);
  }

  await loadCommands();
  loadStatus();
  // Pre-fetch PQC status so info tab is populated immediately
  loadPQCStatus();
}

state.cmdInput.focus();
boot();
</script>
<script src="/command_executor.js"></script>
</body>
</html>
