<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>QTCL v5.0 â€” Quantum Temporal Coherence Ledger</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#050508;
  --bg2:#0a0a12;
  --bg3:#0f0f1a;
  --panel:#0d0d18;
  --border:#1a1a2e;
  --border2:#252545;
  --border-light:#363654;
  --cyan:#00d4ff;
  --cyan2:#00a0cc;
  --cyan-dark:#0088aa;
  --green:#2ecc71;
  --green2:#1a7a45;
  --amber:#f0b429;
  --red:#e05252;
  --purple:#bb86fc;
  --dim:#404060;
  --mid:#606080;
  --text:#d0d0e8;
  --text-dim:#a0a0b8;
  --glow-cyan: 0 0 12px rgba(0,212,255,0.3);
  --glow-green: 0 0 10px rgba(46,204,113,0.25);
  --glow-purple: 0 0 10px rgba(187,134,252,0.25);
  --transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Fira Code','Menlo','Monaco','Courier New',monospace;font-size:13px;background:var(--bg);color:var(--text);line-height:1.6;letter-spacing:0.3px}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
#app{display:flex;flex-direction:column;height:100vh}

/* â”€â”€â”€ TOP BAR â”€â”€â”€ */
#topbar{
  display:flex;align-items:center;gap:0;
  background:linear-gradient(90deg,#02020a 0%,#08081a 100%);
  border-bottom:2px solid var(--border);
  padding:0;
  flex-shrink:0;
  height:50px;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
#brand{
  display:flex;align-items:center;gap:12px;
  padding:0 22px;border-right:2px solid var(--border);
  height:100%;
}
.brand-icon{font-size:18px;color:var(--cyan)}
.brand-name{
  font-size:13px;font-weight:bold;letter-spacing:3px;
  color:var(--cyan);text-shadow:var(--glow-cyan);
}
.brand-version{
  font-size:10px;color:var(--mid);letter-spacing:1px;margin-left:8px;
}

/* â”€â”€â”€ TABS â”€â”€â”€ */
#tabs{display:flex;height:100%;flex:1}
.tab{
  display:flex;align-items:center;gap:8px;
  padding:0 24px;cursor:pointer;
  border-right:1px solid var(--border);
  font-size:11px;letter-spacing:2px;font-weight:bold;
  color:var(--dim);transition:var(--transition);
  text-transform:uppercase;position:relative;
  user-select:none;
}
.tab:hover{color:var(--text);background:rgba(255,255,255,0.01)}
.tab.active{
  color:var(--cyan);
  background:rgba(0,212,255,0.06);
}
.tab.active::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--cyan),var(--cyan2));box-shadow:var(--glow-cyan);
}
.tab-dot{width:7px;height:7px;border-radius:50%;background:var(--dim)}
.tab.active .tab-dot{background:var(--cyan);box-shadow:var(--glow-cyan);animation:pulse 2.5s ease-in-out infinite}

/* â”€â”€â”€ STATUS STRIP â”€â”€â”€ */
#statusbar{
  margin-left:auto;display:flex;align-items:center;gap:20px;
  padding-right:20px;font-size:10px;color:var(--dim);letter-spacing:1px;
  text-transform:uppercase;
}
.stat{display:flex;align-items:center;gap:7px;padding:0 10px}
.stat-dot{width:6px;height:6px;border-radius:50%;animation:pulse 2.5s ease-in-out infinite}
.stat-dot.ok{background:var(--green);box-shadow:var(--glow-green)}
.stat-dot.warn{background:var(--amber);animation:none;opacity:0.7}
.stat-dot.off{background:var(--red);animation:none;opacity:0.6}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(1.1)}}

/* â”€â”€â”€ CONTENT AREA â”€â”€â”€ */
#content{flex:1;overflow:hidden;display:flex}

/* â”€â”€â”€ TERMINAL TAB â”€â”€â”€ */
#terminal-view{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€â”€ TERMINAL OUTPUT â”€â”€â”€ */
#output{
  flex:1;overflow-y:auto;overflow-x:hidden;
  padding:16px 20px;background:var(--bg);
}
#output::-webkit-scrollbar{width:6px}
#output::-webkit-scrollbar-track{background:transparent}
#output::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px;transition:var(--transition)}
#output::-webkit-scrollbar-thumb:hover{background:var(--dim)}

/* â”€â”€â”€ OUTPUT LINES â”€â”€â”€ */
.line{margin-bottom:4px;white-space:pre-wrap;word-wrap:break-word;font-size:13px;animation:fadeIn 0.15s ease;font-variant-numeric:tabular-nums}
@keyframes fadeIn{from{opacity:0;transform:translateY(2px)}to{opacity:1;transform:translateY(0)}}
.line-prompt{color:var(--mid)}
.line-cmd{color:var(--text);font-weight:500}
.line-success{color:var(--green)}
.line-error{color:var(--red)}
.line-info{color:#5a9ccc}
.line-warning{color:var(--amber)}
.line-system{color:var(--cyan);opacity:0.85}
.line-dim{color:var(--dim)}
.line-header{color:var(--cyan);font-weight:bold;letter-spacing:2px;border-bottom:1px solid var(--border);padding-bottom:3px;margin-bottom:6px}

/* prompt line */
.prompt-line{display:flex;gap:7px;margin-bottom:4px;align-items:flex-start}
.prompt-arrow{color:var(--cyan);opacity:0.7;font-weight:bold;min-width:15px}
.prompt-cmd-text{color:var(--text)}

/* â”€â”€â”€ INPUT AREA â”€â”€â”€ */
#inputbar{
  display:flex;align-items:center;
  padding:12px 20px;gap:12px;
  border-top:2px solid var(--border);
  background:linear-gradient(90deg,var(--bg) 0%,var(--bg2) 100%);
  flex-shrink:0;
  position:relative;
  z-index:1000;
  box-shadow:0 -2px 10px rgba(0,0,0,0.5);
}
.input-ps1{color:var(--cyan);opacity:0.8;user-select:none;font-size:13px;flex-shrink:0;font-weight:bold}
#cmd{
  flex:1;background:transparent;border:none;outline:none;
  color:var(--text);font-family:inherit;font-size:13px;caret-color:var(--cyan);
  padding:8px 4px;
}
#cmd::placeholder{color:var(--dim)}
#cmd:focus{color:var(--text);outline:none;border-bottom:1px solid var(--cyan)}
#exec-btn{
  padding:8px 16px;background:rgba(0,212,255,0.08);
  border:1px solid var(--border-light);color:var(--cyan);
  cursor:pointer;border-radius:3px;font-size:11px;letter-spacing:1px;
  font-family:inherit;transition:var(--transition);text-transform:uppercase;font-weight:bold;
  min-width:50px;
}
#exec-btn:hover{background:rgba(0,212,255,0.18);border-color:var(--cyan);box-shadow:0 0 10px rgba(0,212,255,0.2)}
#exec-btn:active{transform:scale(0.98)}

/* â”€â”€â”€ MOBILE OPTIMIZATIONS â”€â”€â”€ */
@media (max-width: 768px) {
  #inputbar{
    padding:14px 16px;gap:10px;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    width:100%;
    border-top:2px solid var(--border);
    box-shadow:0 -2px 15px rgba(0,0,0,0.8);
  }
  
  #terminal-view{
    padding-bottom:65px;
  }
  
  #output{
    padding-bottom:10px;
  }
  
  .input-ps1{
    font-size:12px;
  }
  
  #cmd{
    font-size:15px;
    padding:10px 8px;
    min-height:40px;
  }
  
  #exec-btn{
    padding:10px 14px;
    font-size:12px;
    min-width:60px;
  }
}

/* â”€â”€â”€ INFO TAB â”€â”€â”€ */
#info-view{
  flex:1;display:none;overflow-y:auto;overflow-x:hidden;
  padding:24px;background:var(--bg2);
}
#info-view.active{display:block}
#info-view::-webkit-scrollbar{width:6px}
#info-view::-webkit-scrollbar-track{background:transparent}
#info-view::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
#info-view::-webkit-scrollbar-thumb:hover{background:var(--dim)}

.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;margin-bottom:24px}
.info-card{
  background:linear-gradient(135deg,var(--panel) 0%,var(--bg3) 100%);
  border:1px solid var(--border-light);
  border-radius:6px;padding:18px;
  transition:var(--transition);
  box-shadow:0 4px 6px rgba(0,0,0,0.2);
}
.info-card:hover{border-color:var(--cyan);box-shadow:0 0 15px rgba(0,212,255,0.15)}
.info-card-title{
  font-size:11px;letter-spacing:2px;text-transform:uppercase;
  color:var(--cyan);margin-bottom:14px;opacity:0.9;
  border-bottom:2px solid var(--border);padding-bottom:8px;
  font-weight:bold;
}
.info-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:12px}
.info-key{color:var(--mid);font-weight:500}
.info-val{color:var(--green);font-weight:bold;font-variant-numeric:tabular-nums}
.info-val.dim{color:var(--dim)}
.info-val.warn{color:var(--amber)}
.info-val.cyan{color:var(--cyan)}
.info-val.purple{color:var(--purple)}

.cmd-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.cmd-tag{
  padding:4px 10px;background:rgba(0,212,255,0.08);
  border:1px solid var(--border-light);border-radius:3px;
  font-size:10px;color:var(--cyan);letter-spacing:0.5px;cursor:pointer;
  transition:var(--transition);font-weight:500;
}
.cmd-tag:hover{background:rgba(0,212,255,0.2);border-color:var(--cyan);box-shadow:var(--glow-cyan);transform:scale(1.05)}
.cmd-tag:active{transform:scale(0.95)}

/* â”€â”€â”€ COMMAND CATEGORIES â”€â”€â”€ */
.category-section{margin-bottom:28px}
.category-header{
  font-size:12px;letter-spacing:2px;text-transform:uppercase;
  color:var(--purple);margin-bottom:12px;opacity:0.9;
  font-weight:bold;padding-bottom:6px;border-bottom:1px solid var(--border);
}

/* â”€â”€â”€ BOOT SEQUENCE â”€â”€â”€ */
.boot-line{color:var(--cyan);opacity:0;animation:bootFade 0.4s forwards}
@keyframes bootFade{to{opacity:1}}

/* â”€â”€â”€ SPINNER â”€â”€â”€ */
.spinner{
  display:inline-block;width:12px;height:12px;border:2px solid var(--dim);
  border-top:2px solid var(--cyan);border-radius:50%;
  animation:spin 0.8s linear infinite;vertical-align:middle;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media (max-width: 768px) {
  .brand-name{font-size:11px}
  .tab{padding:0 14px;font-size:9px}
  #topbar{height:45px}
  #inputbar{padding:10px 14px;gap:8px}
  .info-grid{grid-template-columns:1fr}
  #statusbar{gap:10px;padding-right:14px}
}
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar">
    <div id="brand">
      <span class="brand-icon">âš›</span>
      <span class="brand-name">QTCL</span>
      <span class="brand-version">v5.0</span>
    </div>
    <div id="tabs">
      <div class="tab active" data-view="terminal" onclick="switchTab('terminal')">
        <div class="tab-dot"></div>TERMINAL
      </div>
      <div class="tab" data-view="info" onclick="switchTab('info')">
        <div class="tab-dot"></div>INFO
      </div>
    </div>
    <div id="statusbar">
      <div class="stat">
        <div class="stat-dot ok" id="dot-api"></div>
        <span id="lbl-api">API</span>
      </div>
      <div class="stat">
        <div class="stat-dot warn" id="dot-quantum"></div>
        <span id="lbl-quantum">QUANTUM</span>
      </div>
      <div class="stat">
        <div class="stat-dot warn" id="dot-db"></div>
        <span id="lbl-db">DB</span>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- TERMINAL VIEW -->
    <div id="terminal-view">
      <div id="output"></div>
      <div id="inputbar">
        <span class="input-ps1">QTCL â€º</span>
        <input type="text" id="cmd" placeholder="Type 'help' for commandsâ€¦" spellcheck="false" autocomplete="off">
        <button id="exec-btn" onclick="execute()">RUN</button>
      </div>
    </div>

    <!-- INFO VIEW -->
    <div id="info-view">
      <div id="info-content">
        <!-- Dynamically populated -->
      </div>
    </div>

  </div>
</div>

<script>
'use strict';

// â”€â”€â”€ GLOBAL STATE â”€â”€â”€
const state = {
  output: document.getElementById('output'),
  cmdInput: document.getElementById('cmd'),
  cmdHistory: [],
  histIdx: -1,
  statusData: {},
  allCommands: [],
  commandsByCategory: {},
  isLoading: false,
  isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
};

// â”€â”€â”€ MOBILE FOCUS MANAGEMENT â”€â”€â”€
function setupMobileFocus() {
  if (!state.isMobile) return;
  
  // Auto-focus input field on page load
  setTimeout(() => state.cmdInput.focus(), 100);
  
  // Auto-focus when clicking anywhere in terminal area
  document.getElementById('terminal-view').addEventListener('click', (e) => {
    // Don't focus if clicking on output text for selection
    if (e.target.id === 'output') {
      state.cmdInput.focus();
    }
  });
  
  // Keep input visible by focusing when user taps anywhere
  document.addEventListener('touchend', (e) => {
    if (!e.target.closest('#inputbar')) {
      // Slight delay to prevent keyboard from closing
      setTimeout(() => state.cmdInput.focus(), 100);
    }
  });
  
  // Show keyboard when focusing
  state.cmdInput.addEventListener('focus', () => {
    setTimeout(() => {
      state.cmdInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }, 300);
  });
}

// â”€â”€â”€ TAB SWITCHING â”€â”€â”€
function switchTab(name) {
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-view="${name}"]`).classList.add('active');
  
  const termView = document.getElementById('terminal-view');
  const infoView = document.getElementById('info-view');
  
  if (name === 'terminal') {
    termView.style.display = 'flex';
    infoView.classList.remove('active');
    state.cmdInput.focus();
  } else {
    termView.style.display = 'none';
    infoView.classList.add('active');
  }
}

// â”€â”€â”€ OUTPUT UTILITIES â”€â”€â”€
function addLine(text, style = 'system') {
  const line = document.createElement('div');
  line.className = `line line-${style}`;
  line.textContent = text;
  state.output.appendChild(line);
  state.output.scrollTop = state.output.scrollHeight;
}

function addPromptLine(cmd) {
  const container = document.createElement('div');
  container.className = 'prompt-line';
  container.innerHTML = `<span class="prompt-arrow">â€º</span><span class="prompt-cmd-text">${escapeHtml(cmd)}</span>`;
  state.output.appendChild(container);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// â”€â”€â”€ COMMAND EXECUTION (DEEPLY INTEGRATED WITH GLOBALS) â”€â”€â”€
async function execute() {
  const raw = state.cmdInput.value.trim();
  if (!raw || state.isLoading) return;

  state.cmdHistory.unshift(raw);
  state.histIdx = -1;
  state.cmdInput.value = '';

  addPromptLine(raw);

  // Local client-side commands
  const lc = raw.toLowerCase();
  if (lc === 'clear' || lc === 'cls') { state.output.innerHTML = ''; return; }
  if (lc === 'info') { switchTab('info'); return; }
  if (lc === 'help') { showDynamicHelp(); return; }

  state.isLoading = true;
  state.cmdInput.disabled = true;

  try {
    // Execute via /api/command endpoint with full globals integration
    const res = await fetch('/api/command', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ command: raw, args: [], kwargs: {} })
    });

    const data = await res.json().catch(() => ({ error: 'Invalid JSON response' }));

    if (res.ok && (data.status === 'success' || data.result)) {
      const result = data.result;
      if (!result) {
        addLine('âœ“ OK', 'success');
      } else if (typeof result === 'object') {
        if (result.output) {
          result.output.split('\n').forEach(l => {
            if (l.trim()) addLine(l, l.includes('â”€') || l.includes('â•') || l.includes('â•‘') ? 'system' : 'success');
          });
        } else {
          try {
            const pretty = JSON.stringify(result, null, 2);
            pretty.split('\n').forEach(l => addLine(l, 'success'));
          } catch {
            addLine(String(result), 'success');
          }
        }
      } else {
        String(result).split('\n').forEach(l => { if (l.trim()) addLine(l, 'success'); });
      }
    } else {
      const err = data.error || `HTTP ${res.status}`;
      addLine('âœ— ' + err, 'error');
      if (data.suggestions && data.suggestions.length) {
        addLine('Similar: ' + data.suggestions.join(', '), 'warning');
      }
    }
  } catch (err) {
    addLine('Network error: ' + err.message, 'error');
  } finally {
    state.isLoading = false;
    state.cmdInput.disabled = false;
    state.output.scrollTop = state.output.scrollHeight;
    state.cmdInput.focus();
  }
}

// â”€â”€â”€ DYNAMIC COMMAND LOADING FROM /api/commands â”€â”€â”€
async function loadCommands() {
  try {
    addLine('Loading command registry from globalsâ€¦', 'dim');
    const res = await fetch('/api/commands');
    if (res.ok) {
      const data = await res.json();
      state.allCommands = data.commands || [];
      state.commandsByCategory = {};
      
      state.allCommands.forEach(cmd => {
        if (!state.commandsByCategory[cmd.category]) {
          state.commandsByCategory[cmd.category] = [];
        }
        state.commandsByCategory[cmd.category].push(cmd);
      });
      
      addLine(`âœ“ Loaded ${state.allCommands.length} commands from registry`, 'success');
      renderInfoGrid();
    } else {
      addLine('âš  Could not load commands', 'warning');
    }
  } catch (e) {
    addLine(`âš  Command load error: ${e.message}`, 'warning');
    console.error('Command load failed:', e);
  }
}

// â”€â”€â”€ DYNAMIC HELP (SCRAPES FROM GLOBALS REGISTRY) â”€â”€â”€
function showDynamicHelp() {
  addLine('', 'dim');
  addLine('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'system');
  addLine('â•‘  QTCL v5.0 â€” COMMAND REFERENCE & SYNTAX GUIDE          â•‘', 'system');
  addLine('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'system');
  addLine('', 'dim');
  
  addLine('ðŸ“± MOBILE UX TIPS:', 'info');
  addLine('  â€¢ Input box auto-focuses at bottom of screen', 'dim');
  addLine('  â€¢ Click/tap terminal â†’ input focuses', 'dim');
  addLine('  â€¢ Keyboard opens automatically', 'dim');
  addLine('  â€¢ Press RUN button or Enter to execute', 'dim');
  addLine('', 'dim');
  
  addLine('ðŸŽ¯ COMMAND SYNTAX (CRITICAL - READ THIS):', 'warning');
  addLine('  Format: category/command (with forward slash /)', 'text');
  addLine('', 'dim');
  addLine('  RIGHT EXAMPLES:', 'success');
  addLine('    âœ“ admin/users       (admin category, users command)', 'dim');
  addLine('    âœ“ quantum/status    (quantum category, status command)', 'dim');
  addLine('    âœ“ block/history 10  (blockchain, history with param)', 'dim');
  addLine('    âœ“ system/health     (system category, health command)', 'dim');
  addLine('', 'dim');
  addLine('  WRONG EXAMPLES (DON\'T USE):', 'error');
  addLine('    âœ— help admin              (missing /category)', 'dim');
  addLine('    âœ— admin                   (just category, not command)', 'dim');
  addLine('    âœ— quantum status          (missing /)', 'dim');
  addLine('    âœ— block 1                 (should be block/details 1)', 'dim');
  addLine('', 'dim');
  
  addLine('ðŸ“– HELP COMMANDS:', 'info');
  addLine('  help                       This menu', 'dim');
  addLine('  help/commands             List ALL 82+ commands', 'dim');
  addLine('  help/category admin       Show admin commands only', 'dim');
  addLine('  help/category quantum     Show quantum commands only', 'dim');
  addLine('  help/category blockchain  Show blockchain commands only', 'dim');
  addLine('', 'dim');
  
  if (Object.keys(state.commandsByCategory).length === 0) {
    addLine('(Commands not yet loaded - visit INFO tab to load)', 'dim');
  } else {
    addLine('ðŸ“‚ COMMAND CATEGORIES (15 total):', 'info');
    const categories = Object.keys(state.commandsByCategory).sort();
    categories.forEach(cat => {
      const cmds = state.commandsByCategory[cat];
      const count = cmds.length;
      addLine(`  ${cat.padEnd(15)} (${count} commands) - type: help/category ${cat}`, 'dim');
    });
  }
  
  addLine('', 'dim');
  addLine('ðŸ’¡ QUICK START:', 'info');
  addLine('  1. Type: help/commands     (see all available)', 'dim');
  addLine('  2. Type: help/category admin     (see admin commands)', 'dim');
  addLine('  3. Type: admin/users       (execute a command)', 'dim');
  addLine('  4. Click INFO tab for system status & quick launch', 'dim');
  addLine('', 'dim');
}

// â”€â”€â”€ KEYBOARD HANDLING â”€â”€â”€
state.cmdInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') { 
    e.preventDefault(); 
    execute(); 
  }
  else if (e.key === 'ArrowUp') {
    e.preventDefault();
    state.histIdx = Math.min(state.histIdx + 1, state.cmdHistory.length - 1);
    if (state.histIdx >= 0) state.cmdInput.value = state.cmdHistory[state.histIdx];
  }
  else if (e.key === 'ArrowDown') {
    e.preventDefault();
    state.histIdx = Math.max(state.histIdx - 1, -1);
    state.cmdInput.value = state.histIdx >= 0 ? state.cmdHistory[state.histIdx] : '';
  }
});

// â”€â”€â”€ STATUS POLLING (INTEGRATES WITH GLOBALS VIA /api/status) â”€â”€â”€
async function loadStatus() {
  try {
    const r = await fetch('/api/status');
    if (r.ok) {
      const d = await r.json();
      state.statusData = d;
      
      const qok = d.quantum && (d.quantum.status === 'active' || d.quantum.status === 'Active');
      setDot('quantum', qok ? 'ok' : 'warn');
      document.getElementById('lbl-quantum').textContent = 
        d.quantum ? (d.quantum.status || 'QUANTUM').toUpperCase().slice(0, 10) : 'QUANTUM';
      
      const dbok = d.database || d.db;
      setDot('db', dbok ? 'ok' : 'warn');
      
      setDot('api', 'ok');
      
      if (d.ledger && typeof d.ledger.blocks === 'number') {
        document.getElementById('lbl-db').textContent = d.ledger.blocks + ' BLK';
      }
    }
  } catch (e) { 
    setDot('api', 'warn');
  }
}

function setDot(id, cls) {
  const d = document.getElementById('dot-' + id);
  if (d) d.className = 'stat-dot ' + cls;
}

setInterval(loadStatus, 12000);

// â”€â”€â”€ INFO GRID (DEEP GLOBALS INTEGRATION) â”€â”€â”€
function renderInfoGrid() {
  const container = document.getElementById('info-content');
  container.innerHTML = '';

  // System Architecture Card
  const archCard = document.createElement('div');
  archCard.className = 'info-card';
  archCard.innerHTML = `
    <div class="info-card-title">System Architecture</div>
    <div class="info-row"><span class="info-key">Blockchain Type</span><span class="info-val">Quantum-Classical</span></div>
    <div class="info-row"><span class="info-key">Consensus</span><span class="info-val">Quantum PoW + Classical PoS</span></div>
    <div class="info-row"><span class="info-key">Validator Qubits</span><span class="info-val cyan">5 (W-State)</span></div>
    <div class="info-row"><span class="info-key">Finality Proofs</span><span class="info-val purple">8-GHZ Circuit</span></div>
  `;
  
  // Quantum Subsystem Card
  const qCard = document.createElement('div');
  qCard.className = 'info-card';
  qCard.innerHTML = `
    <div class="info-card-title">Quantum Subsystem</div>
    <div class="info-row"><span class="info-key">Engine</span><span class="info-val">${state.statusData.quantum?.status || 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">W-State</span><span class="info-val cyan">${state.statusData.quantum?.w_state || 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Coherence</span><span class="info-val purple">${state.statusData.quantum?.coherence || 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Entropy Pool</span><span class="info-val">${state.statusData.quantum?.entropy || 'â€”'}</span></div>
  `;
  
  // Ledger Status Card
  const ledgerCard = document.createElement('div');
  ledgerCard.className = 'info-card';
  ledgerCard.innerHTML = `
    <div class="info-card-title">Ledger Status</div>
    <div class="info-row"><span class="info-key">Blocks</span><span class="info-val">${state.statusData.ledger?.blocks ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Transactions</span><span class="info-val">${state.statusData.ledger?.transactions ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Validators</span><span class="info-val">${state.statusData.ledger?.validators ?? 'â€”'}</span></div>
    <div class="info-row"><span class="info-key">Uptime</span><span class="info-val">${state.statusData.uptime ? Math.round(state.statusData.uptime) + 's' : 'â€”'}</span></div>
  `;
  
  // DeFi & Oracle Card
  const defiCard = document.createElement('div');
  defiCard.className = 'info-card';
  defiCard.innerHTML = `
    <div class="info-card-title">DeFi & Oracle</div>
    <div class="info-row"><span class="info-key">Staking</span><span class="info-val green">Available</span></div>
    <div class="info-row"><span class="info-key">AMM Swaps</span><span class="info-val green">Active</span></div>
    <div class="info-row"><span class="info-key">Price Oracle</span><span class="info-val green">Integrated</span></div>
    <div class="info-row"><span class="info-key">QRNG</span><span class="info-val green">Active</span></div>
  `;
  
  const grid = document.createElement('div');
  grid.className = 'info-grid';
  grid.appendChild(archCard);
  grid.appendChild(qCard);
  grid.appendChild(ledgerCard);
  grid.appendChild(defiCard);
  container.appendChild(grid);

  // Command Quick Launch by Category (from globals registry)
  const cats = Object.keys(state.commandsByCategory).sort();
  
  if (cats.length === 0) {
    const noCmd = document.createElement('div');
    noCmd.style.color = 'var(--dim)';
    noCmd.style.padding = '20px';
    noCmd.textContent = 'Commands not yet loaded. Run "help" in terminal.';
    container.appendChild(noCmd);
    return;
  }
  
  cats.forEach(category => {
    const section = document.createElement('div');
    section.className = 'category-section';
    
    const header = document.createElement('div');
    header.className = 'category-header';
    header.textContent = category.toUpperCase();
    section.appendChild(header);
    
    const cmdList = document.createElement('div');
    cmdList.className = 'cmd-list';
    
    state.commandsByCategory[category].forEach(cmd => {
      const tag = document.createElement('span');
      tag.className = 'cmd-tag';
      tag.textContent = cmd.command;
      tag.onclick = () => runQuick(cmd.command);
      cmdList.appendChild(tag);
    });
    
    section.appendChild(cmdList);
    container.appendChild(section);
  });
}

function runQuick(cmd) {
  switchTab('terminal');
  state.cmdInput.value = cmd;
  execute();
}

// â”€â”€â”€ BOOT SEQUENCE â”€â”€â”€
async function boot() {
  // Setup mobile focus first
  setupMobileFocus();
  
  const BOOT = [
    { t: 0, msg: 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', cls: 'system' },
    { t: 30, msg: 'â•‘     QUANTUM TEMPORAL COHERENCE LEDGER  v5.0               â•‘', cls: 'system' },
    { t: 30, msg: 'â•‘     Hybrid Blockchain Command Interface                    â•‘', cls: 'system' },
    { t: 30, msg: 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', cls: 'system' },
    { t: 80, msg: '', cls: 'info' },
    { t: 60, msg: 'Initializing quantum subsystemâ€¦', cls: 'info' },
    { t: 80, msg: 'Loading command registry from globalsâ€¦', cls: 'info' },
    { t: 60, msg: 'Connecting to PostgreSQL ledgerâ€¦', cls: 'info' },
    { t: 100, msg: '', cls: 'info' },
    { t: 60, msg: 'Type  help          â€” list all commands from globals', cls: 'dim' },
    { t: 40, msg: 'Type  system-status â€” full system health', cls: 'dim' },
    { t: 40, msg: 'Type  version       â€” build version info', cls: 'dim' },
    { t: 40, msg: 'Click INFO tab      â€” system details & quick command launch', cls: 'dim' },
    { t: 80, msg: '', cls: 'info' },
    { t: 60, msg: 'Ready.', cls: 'success' },
    { t: 20, msg: '', cls: 'info' },
  ];

  let delay = 0;
  for (const { t, msg, cls } of BOOT) {
    delay += t;
    await new Promise(r => setTimeout(r, delay));
    addLine(msg, cls);
  }

  // Load commands and status from globals
  await loadCommands();
  loadStatus();
}

state.cmdInput.focus();
boot();
</script>
</body>
</html>
